// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// User Management
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  role          String      @default("CUSTOMER")
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  isArchived    Boolean   @default(false)
  
  addresses     Address[]
  orders        Order[]
  cart          CartItem[]
  wishlist      WishlistItem[]
  
  // New relations for customized machines
  machines      CustomerMachine[]
  supportTickets SupportTicket[]
}

// Role enum (mapped to String for SQLite)
// CUSTOMER, DEALER, ADMIN

model Address {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name         String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  pincode      String
  isDefault    Boolean  @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Product Catalog
model Product {
  id             String   @id @default(cuid())
  partNumber     String   @unique
  name           String
  description    String
  category       String
  price          Float
  images         String // Array of image URLs (JSON string)
  specifications String // Technical specs (JSON string)
  isActive       Boolean  @default(true)
  
  // New fields for customized parts
  isCustomPart   Boolean  @default(false) // Is this a custom/specialized part?
  customizationRequired String // Customization IDs (JSON string)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  cartItems      CartItem[]
  orderItems     OrderItem[]
  wishlistItems  WishlistItem[]
  
  // New relations for machine compatibility
  compatibility  PartCompatibility[]
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, productId])
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, productId])
}

// Orders
model Order {
  id                String        @id @default(cuid())
  orderNumber       String        @unique
  userId            String
  user              User          @relation(fields: [userId], references: [id])
  
  status            String        @default("PENDING")
  totalAmount       Float
  paymentMethod     String
  paymentStatus     String        @default("PENDING")
  paymentId         String?
  
  deliveryAddress   String // Snapshot of address at order time (JSON string)
  
  deliveryPartner   String?
  trackingId        String?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  
  notes             String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  items             OrderItem[]
  routings          OrderRouting[]
  manifests         Manifest[]
  returns           Return[]
}

// OrderStatus enum (mapped to String for SQLite)
// PENDING, PAYMENT_PENDING, ..., RETURNED

// PaymentMethod enum (mapped to String for SQLite)
// ONLINE, COD, CREDIT

// PaymentStatus enum (mapped to String for SQLite)
// PENDING, SUCCESS, FAILED, REFUNDED, PARTIAL_REFUND

// DeliveryPartner enum (mapped to String for SQLite)
// PORTER, DELHIVERY

model OrderItem {
  id          String          @id @default(cuid())
  orderId     String
  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product         @relation(fields: [productId], references: [id])
  
  quantity    Int
  price       Float // Price at order time
  
  status      String          @default("PENDING")
  fulfilledBy String? // Dealer/Warehouse ID
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// OrderItemStatus enum (mapped to String for SQLite)
// PENDING, CONFIRMED, REJECTED, FULFILLED

// Dealer Management
model Dealer {
  id              String      @id @default(cuid())
  name            String
  email           String      @unique
  password        String
  phone           String
  level           String
  
  address         String
  city            String
  state           String
  pincode         String
  
  servicePincodes String // Pincodes this dealer serves (JSON string)
  
  isActive        Boolean     @default(true)
  responseSLA     Int         @default(120) // Minutes
  
  performanceScore Float      @default(100.0)
  totalOrders      Int        @default(0)
  approvedOrders   Int        @default(0)
  rejectedOrders   Int        @default(0)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  routings        OrderRouting[]
  manifests       Manifest[]
}

// DealerLevel enum (mapped to String for SQLite)
// L1, L2, L3, WAREHOUSE

model OrderRouting {
  id          String        @id @default(cuid())
  orderId     String
  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  dealerId    String
  dealer      Dealer        @relation(fields: [dealerId], references: [id])
  
  level       String
  status      String        @default("PENDING")
  
  routedAt    DateTime      @default(now())
  respondedAt DateTime?
  response    String? // Approval/rejection notes
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([orderId, level])
}

// RoutingStatus enum (mapped to String for SQLite)
// PENDING, APPROVED, REJECTED, EXPIRED

// Manifest & Delivery
model Manifest {
  id                String         @id @default(cuid())
  manifestNumber    String         @unique
  orderId           String
  order             Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  dealerId          String
  dealer            Dealer         @relation(fields: [dealerId], references: [id])
  
  pickupAddress     String // (JSON string)
  deliveryAddress   String // (JSON string)
  items             String // Item details (JSON string)
  
  deliveryPartner   String
  trackingId        String?
  
  status            String         @default("CREATED")
  
  scheduledPickup   DateTime?
  actualPickup      DateTime?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

// ManifestStatus enum (mapped to String for SQLite)
// CREATED, ..., FAILED

// Returns
model Return {
  id           String       @id @default(cuid())
  orderId      String
  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  reason       String
  description  String
  photos       String // Photo URLs (JSON string)
  
  status       String @default("PENDING")
  
  approvedBy   String?
  approvedAt   DateTime?
  
  refundAmount Float?
  refundStatus String @default("PENDING")
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

// ReturnReason enum (mapped to String for SQLite)

// ReturnStatus enum (mapped to String for SQLite)

// RefundStatus enum (mapped to String for SQLite)

// Machine & Customization Management
model Machine {
  id                String              @id @default(cuid())
  machineNumber     String              @unique // e.g., "ACE-FX14-2024"
  name              String              // e.g., "FX 14 Mobile Crane"
  category          String              // e.g., "Mobile Cranes"
  model             String              // e.g., "FX 14"
  manufacturer      String              @default("ACE")
  
  description       String
  specifications    String                // Technical specs
  images            String                // Machine images
  
  isCustomizable    Boolean             @default(false)
  isActive          Boolean             @default(true)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  customerMachines  CustomerMachine[]
  compatibleParts   PartCompatibility[]
  customizations    MachineCustomization[]
}

model CustomerMachine {
  id                    String                @id @default(cuid())
  userId                String
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  machineId             String
  machine               Machine               @relation(fields: [machineId], references: [id])
  
  serialNumber          String?               // Customer's machine serial number
  purchaseDate          DateTime?
  
  hasCustomization      Boolean               @default(false)
  customizationDetails  String?                 // Specific customizations (JSON string)
  
  nickname              String?               // Customer's nickname for the machine
  notes                 String?
  
  isActive              Boolean               @default(true)
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  customizations        CustomerMachineCustomization[]
  supportTickets        SupportTicket[]
  
  @@unique([userId, machineId, serialNumber])
  @@index([userId])
}

model MachineCustomization {
  id                String   @id @default(cuid())
  machineId         String
  machine           Machine  @relation(fields: [machineId], references: [id])
  
  name              String   // e.g., "Extended Boom"
  description       String
  customizationType String   // e.g., "Structural", "Hydraulic", "Electrical"
  
  affectedParts     String     // (JSON string)
  additionalParts   String     // (JSON string)
  
  isActive          Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  customerMachines  CustomerMachineCustomization[]
}

model CustomerMachineCustomization {
  id                      String               @id @default(cuid())
  customerMachineId       String
  customerMachine         CustomerMachine      @relation(fields: [customerMachineId], references: [id], onDelete: Cascade)
  customizationId         String
  customization           MachineCustomization @relation(fields: [customizationId], references: [id])
  
  installedDate           DateTime?
  notes                   String?
  
  createdAt               DateTime             @default(now())
  
  @@unique([customerMachineId, customizationId])
}

model PartCompatibility {
  id                String   @id @default(cuid())
  productId         String
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  machineId         String
  machine           Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  
  isStandardPart    Boolean  @default(true)  // Standard part for this machine
  isCustomPart      Boolean  @default(false) // Part for customized machines
  
  customizationIds  String // (JSON string)
  
  compatibilityNotes String?
  installationGuide  String?
  
  priority          Int      @default(0) // Higher priority = more commonly needed
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([productId, machineId])
  @@index([machineId])
  @@index([productId])
}

// Customer Support Workflow
model SupportTicket {
  id                  String              @id @default(cuid())
  ticketNumber        String              @unique
  userId              String
  user                User                @relation(fields: [userId], references: [id])
  customerMachineId   String?
  customerMachine     CustomerMachine?    @relation(fields: [customerMachineId], references: [id])
  
  type                String   @default("PART_INQUIRY")
  status              String @default("OPEN")
  priority            String     @default("MEDIUM")
  
  subject             String
  description         String
  
  assignedTo          String?             // Support agent ID
  
  whatsappNumber      String?
  whatsappChatId      String?
  
  confirmedParts      String?               // (JSON string)
  sharedCartLink      String?             // Link to add parts to cart
  
  resolution          String?
  resolvedAt          DateTime?
  
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  messages            SupportMessage[]
  
  @@index([userId])
  @@index([status])
}

// SupportTicketType enum (mapped to String for SQLite)

// SupportTicketStatus enum (mapped to String for SQLite)

// SupportPriority enum (mapped to String for SQLite)

model SupportMessage {
  id              String        @id @default(cuid())
  ticketId        String
  ticket          SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  senderId        String        // User ID or Support Agent ID
  senderType      String        // "CUSTOMER" or "SUPPORT"
  
  message         String
  attachments     String      // URLs to attachments (JSON string)
  
  isWhatsApp      Boolean       @default(false)
  whatsappMsgId   String?
  
  createdAt       DateTime      @default(now())
  
  @@index([ticketId])
}

// Smart Part Suggestions
model PartSuggestion {
  id                String   @id @default(cuid())
  userId            String
  productId         String
  machineId         String?
  
  suggestionType    String
  reason            String   // Why this part is suggested
  
  relevanceScore    Float    @default(0.0) // 0-100
  
  isViewed          Boolean  @default(false)
  isClicked         Boolean  @default(false)
  isPurchased       Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  
  @@index([userId])
  @@index([productId])
}

// SuggestionType enum (mapped to String for SQLite)

// Comprehensive Repository
model MachineRepository {
  id                String   @id @default(cuid())
  
  // Aggregated data for analytics
  totalMachines     Int      @default(0)
  totalCustomers    Int      @default(0)
  totalParts        Int      @default(0)
  totalCustomizations Int    @default(0)
  
  lastSyncedAt      DateTime @default(now())
  
  // Metadata
  metadata          String // (JSON string)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}


